package de.kilip.library;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/*
* used to encode and decode a base 60k number into/from unicode characters
* (
* Minecraft only supports unifont and some cusotm characters
* (which were previously used, but are now omitted for simplicity)
* )
*/
public class Unifont {
    private static final List<Integer> ALPHABET = new ArrayList<>();
    private static final Map<Integer, Integer> REVERSE = new HashMap<>();
    private static final BigInteger BASE;
    int[][] ranges  = {{0x0, 0xd7ff}, {0xf900, 0xfdff}, {0xfe10, 0xfffd}, {0x20546, 0x20547}, {0x20ccf, 0x20cd0}, {0x20cd4, 0x20cd5}, {0x20e0e, 0x20e0f}, {0x20e76, 0x20e77}, {0x20ed7, 0x20ed8}, {0x20ef9, 0x20efa}, {0x20f2d, 0x20f2e}, {0x21075, 0x21076}, {0x2146d, 0x2146e}, {0x21e33, 0x21e34}, {0x22b4f, 0x22b50}, {0x23073, 0x23074}, {0x231c3, 0x231c4}, {0x233d2, 0x233d3}, {0x2344a, 0x2344b}, {0x23638, 0x2363a}, {0x23763, 0x23764}, {0x23c97, 0x23c98}, {0x23df9, 0x23dfa}, {0x23e23, 0x23e24}, {0x255a7, 0x255a8}, {0x25ae3, 0x25ae4}, {0x25ed7, 0x25ed8}, {0x26ff6, 0x26ff8}, {0x273da, 0x273db}, {0x27614, 0x27615}, {0x27a3e, 0x27a3f}, {0x280be, 0x280bf}, {0x285c8, 0x285c9}, {0x28948, 0x28949}, {0x28987, 0x28988}, {0x289ba, 0x289bb}, {0x28c4d, 0x28c4f}, {0x28c53, 0x28c54}, {0x29750, 0x29751}, {0x2980c, 0x2980d}, {0x2a04e, 0x2a04f}, {0x2b127, 0x2b128}, {0x2b137, 0x2b138}, {0x2b362, 0x2b363}, {0x2b50d, 0x2b50e}, {0x2b5ae, 0x2b5af}, {0x2b61c, 0x2b61d}, {0x2b626, 0x2b628}, {0x2b694, 0x2b696}, {0x2b740, 0x2b81d}, {0x2c029, 0x2c02a}, {0x2c621, 0x2c622}, {0x2c62b, 0x2c62d}, {0x2c64a, 0x2c64b}, {0x2cb2d, 0x2cb2e}, {0x2cb38, 0x2cb3b}, {0x2cb5a, 0x2cb5b}, {0x2cb63, 0x2cb64}, {0x2cbbf, 0x2cbc0}, {0x2ccf5, 0x2ccf6}, {0x2cd02, 0x2cd03}, {0x2cd8f, 0x2cd90}, {0x2cd9f, 0x2cda0}, {0x2cdad, 0x2cdae}, {0x2e26b, 0x2e26c}, {0x2e64a, 0x2e64b}, {0x2e774, 0x2e775}, {0x2e8f2, 0x2e8f3}, {0x2ea5d, 0x2ea5e}, {0x2ebf0, 0x2ee5d}, {0x30d5d, 0x30d5e}, {0x30edd, 0x30ede}};
    int[]   special = {0x14,0x1f12f, 0x2000b, 0x20087, 0x20089, 0x200a2, 0x200a4, 0x200cc, 0x20164, 0x201a2, 0x201d4, 0x20213, 0x20242, 0x2028e, 0x2032b, 0x20350, 0x20371, 0x20381, 0x203b7, 0x203f9, 0x2044a, 0x20509, 0x20584, 0x205d6, 0x205fb, 0x20628, 0x20676, 0x206a4, 0x2070e, 0x20731, 0x2074f, 0x20779, 0x207a9, 0x207ad, 0x20803, 0x20807, 0x2081d, 0x2083a, 0x20895, 0x208b9, 0x2097c, 0x2099d, 0x209da, 0x20ad3, 0x20b1d, 0x20b9f, 0x20bd7, 0x20c41, 0x20c53, 0x20c78, 0x20c8e, 0x20c96, 0x20cbf, 0x20d15, 0x20d45, 0x20d5d, 0x20d71, 0x20d7c, 0x20d7f, 0x20da7, 0x20de1, 0x20e01, 0x20e64, 0x20e6d, 0x20e95, 0x20e98, 0x20e9d, 0x20ea2, 0x20f3b, 0x20f4c, 0x20f5f, 0x20f7e, 0x20f90, 0x20fb4, 0x20fbc, 0x20fea, 0x21014, 0x2105c, 0x2106f, 0x2107b, 0x210ab, 0x210bf, 0x210c1, 0x210c9, 0x210f6, 0x21145, 0x211d9, 0x21201, 0x2123d, 0x21255, 0x21274, 0x2127b, 0x212d7, 0x212e4, 0x212fd, 0x2131b, 0x21336, 0x21344, 0x2134c, 0x21377, 0x2139a, 0x213c4, 0x213cb, 0x21413, 0x2144d, 0x21484, 0x215d7, 0x21647, 0x216a6, 0x216b4, 0x216df, 0x216f0, 0x21706, 0x21742, 0x21757, 0x2176d, 0x217d3, 0x2180d, 0x21883, 0x218bd, 0x2197c, 0x219c3, 0x21c2a, 0x21c56, 0x21ca2, 0x21cde, 0x21d2d, 0x21d45, 0x21d62, 0x21d78, 0x21d92, 0x21d9c, 0x21da1, 0x21da6, 0x21db7, 0x21dd1, 0x21de0, 0x21e8e, 0x21f0f, 0x21f1e, 0x21f76, 0x21ffa, 0x22016, 0x220c7, 0x2217b, 0x221a1, 0x22218, 0x2231e, 0x22399, 0x223ad, 0x22489, 0x224dc, 0x2251b, 0x22650, 0x226f3, 0x22775, 0x227b5, 0x2285b, 0x228ab, 0x2298f, 0x22ab1, 0x22ab8, 0x22acf, 0x22ad5, 0x22ae6, 0x22aec, 0x22b43, 0x22b46, 0x22ba6, 0x22bca, 0x22bed, 0x22bfe, 0x22c1d, 0x22c24, 0x22c49, 0x22c4b, 0x22c51, 0x22c55, 0x22c62, 0x22c64, 0x22cb4, 0x22cb8, 0x22cc2, 0x22cc6, 0x22cea, 0x22d08, 0x22d4c, 0x22d67, 0x22d80, 0x22de1, 0x22eb3, 0x22f0c, 0x22f1b, 0x22f7e, 0x231b6, 0x231f5, 0x23236, 0x23350, 0x23372, 0x233d0, 0x233d5, 0x233da, 0x233df, 0x233e2, 0x233e4, 0x2343f, 0x23451, 0x23465, 0x234e4, 0x2355a, 0x23594, 0x235c4, 0x235cb, 0x23647, 0x236ba, 0x236ee, 0x2370c, 0x2371c, 0x2373f, 0x237e7, 0x237ff, 0x23824, 0x2383d, 0x23a3c, 0x23a98, 0x23b02, 0x23b20, 0x23b36, 0x23b72, 0x23b88, 0x23c5d, 0x23c7c, 0x23c7f, 0x23ca9, 0x23cb7, 0x23cfe, 0x23d00, 0x23d0e, 0x23d40, 0x23d66, 0x23dd3, 0x23ef8, 0x23f0e, 0x23f7e, 0x24096, 0x240d2, 0x24103, 0x241a2, 0x241ac, 0x241b5, 0x241c6, 0x241fe, 0x2420e, 0x24259, 0x242b6, 0x2430d, 0x24319, 0x24352, 0x24364, 0x243bc, 0x24419, 0x24430, 0x244d3, 0x24605, 0x24629, 0x246a5, 0x2479a, 0x247a4, 0x247b6, 0x247ef, 0x247f1, 0x24896, 0x248e9, 0x249db, 0x24a01, 0x24a4d, 0x24a7d, 0x24ac9, 0x24b56, 0x24b62, 0x24b6f, 0x24be5, 0x24c16, 0x24c59, 0x24c8d, 0x24d14, 0x24d80, 0x24d83, 0x24db8, 0x24dea, 0x24e01, 0x24e0e, 0x24e31, 0x24e37, 0x24e6a, 0x24e85, 0x24e8b, 0x24ea7, 0x24eaa, 0x24eca, 0x2504a, 0x25055, 0x25122, 0x25128, 0x2512b, 0x25148, 0x2517e, 0x251a7, 0x251a9, 0x251cd, 0x251e5, 0x2521e, 0x2524c, 0x25273, 0x2531a, 0x25349, 0x2542e, 0x25435, 0x2546e, 0x2548e, 0x254d9, 0x2550e, 0x25532, 0x2554d, 0x25562, 0x25584, 0x255fd, 0x25771, 0x257a9, 0x257b4, 0x257c7, 0x25977, 0x259c4, 0x259d4, 0x25ad7, 0x25af1, 0x25bb2, 0x25bdf, 0x25be5, 0x25be8, 0x25c14, 0x25c4b, 0x25c64, 0x25d0a, 0x25da1, 0x25e2e, 0x25e49, 0x25e56, 0x25e62, 0x25e65, 0x25e86, 0x25ec2, 0x25ee8, 0x25ef5, 0x25f23, 0x25f5c, 0x25fd4, 0x25fe0, 0x25ffb, 0x2600c, 0x26017, 0x26060, 0x260ed, 0x26221, 0x2624e, 0x26258, 0x26270, 0x26286, 0x26293, 0x2634c, 0x26393, 0x263f4, 0x26402, 0x2648d, 0x265d2, 0x26676, 0x2667e, 0x266b0, 0x266e8, 0x26706, 0x2671d, 0x2677c, 0x267cc, 0x267ea, 0x2683f, 0x2688a, 0x268dd, 0x268ea, 0x2690e, 0x26951, 0x2696f, 0x269dd, 0x269f2, 0x269fa, 0x26a1e, 0x26a29, 0x26a2d, 0x26a58, 0x26a8c, 0x26ab7, 0x26abd, 0x26aff, 0x26b4c, 0x26b5c, 0x26c21, 0x26c29, 0x26c73, 0x26cdd, 0x26d9f, 0x26e05, 0x26e40, 0x26e65, 0x26ed8, 0x26f94, 0x270f4, 0x2710d, 0x27139, 0x2725f, 0x27285, 0x27304, 0x27371, 0x273fe, 0x27410, 0x27449, 0x27486, 0x274bd, 0x27631, 0x27684, 0x27693, 0x2770e, 0x27723, 0x27741, 0x27752, 0x277f0, 0x278b2, 0x27985, 0x279a0, 0x279a7, 0x27a63, 0x27a84, 0x27b2a, 0x27b99, 0x27baa, 0x27bb3, 0x27bbe, 0x27bc7, 0x27cb8, 0x27da0, 0x27e10, 0x27eaf, 0x27ef4, 0x27fb7, 0x27fc1, 0x27fec, 0x27ff3, 0x27ff9, 0x2808a, 0x280bb, 0x280c5, 0x280e9, 0x280f0, 0x28154, 0x2815d, 0x28207, 0x28277, 0x28282, 0x282cd, 0x282e2, 0x282f3, 0x2837d, 0x2838a, 0x283cd, 0x28408, 0x2840c, 0x28455, 0x28468, 0x28487, 0x2856b, 0x28595, 0x28678, 0x28695, 0x286d7, 0x286fa, 0x287aa, 0x287e0, 0x28891, 0x28946, 0x2896b, 0x289a1, 0x289c0, 0x28a0f, 0x28a1e, 0x28a29, 0x28a43, 0x28a71, 0x28a99, 0x28acd, 0x28add, 0x28ae4, 0x28b46, 0x28b49, 0x28b4e, 0x28bc1, 0x28bef, 0x28c3e, 0x28c47, 0x28c51, 0x28cca, 0x28ccd, 0x28cd2, 0x28d10, 0x28d71, 0x28d99, 0x28dfb, 0x28e0f, 0x28e1f, 0x28e36, 0x28e39, 0x28e89, 0x28e99, 0x28ee7, 0x28eeb, 0x28ef6, 0x28f32, 0x28ff8, 0x2925c, 0x292a0, 0x292b1, 0x2945d, 0x2947e, 0x29490, 0x294ba, 0x294e5, 0x295cf, 0x2967f, 0x296a8, 0x296e9, 0x296f0, 0x29704, 0x29719, 0x29730, 0x29810, 0x298c6, 0x29a02, 0x29a72, 0x29d71, 0x29d98, 0x29dd3, 0x29dd5, 0x29ddb, 0x29e15, 0x29e19, 0x29e36, 0x29e3d, 0x29e49, 0x29e8a, 0x29eac, 0x29ec4, 0x29edb, 0x29ee9, 0x29f27, 0x29f30, 0x29f48, 0x29f70, 0x29f7c, 0x29f7e, 0x29f83, 0x29f87, 0x29f8c, 0x29fce, 0x2a01a, 0x2a02f, 0x2a082, 0x2a0ba, 0x2a0f9, 0x2a190, 0x2a1e1, 0x2a248, 0x2a38a, 0x2a38c, 0x2a41e, 0x2a437, 0x2a590, 0x2a5f1, 0x2a602, 0x2a612, 0x2a61a, 0x2a64a, 0x2a6b2, 0x2a736, 0x2a79d, 0x2a7dd, 0x2a838, 0x2a83d, 0x2a8ae, 0x2a8dd, 0x2a8fb, 0x2a917, 0x2a970, 0x2aa07, 0x2aa0a, 0x2aa30, 0x2aa36, 0x2aa58, 0x2ab62, 0x2ae5a, 0x2aed0, 0x2af94, 0x2afa2, 0x2afd6, 0x2b0d1, 0x2b125, 0x2b1ed, 0x2b241, 0x2b2bb, 0x2b300, 0x2b328, 0x2b35f, 0x2b36f, 0x2b372, 0x2b37b, 0x2b37d, 0x2b404, 0x2b410, 0x2b413, 0x2b461, 0x2b4a2, 0x2b4e7, 0x2b4e9, 0x2b4ef, 0x2b4f6, 0x2b4f9, 0x2b536, 0x2b583, 0x2b594, 0x2b598, 0x2b5b3, 0x2b5b9, 0x2b5e7, 0x2b5eb, 0x2b5f0, 0x2b5f4, 0x2b624, 0x2b62a, 0x2b62c, 0x2b689, 0x2b692, 0x2b6ad, 0x2b6da, 0x2b6de, 0x2b6e9, 0x2b6ed, 0x2b6f6, 0x2b728, 0x2b737, 0x2b8b8, 0x2b8c6, 0x2b8ca, 0x2b9ef, 0x2ba5b, 0x2ba81, 0x2ba98, 0x2bac7, 0x2bb37, 0x2bb5f, 0x2bb62, 0x2bb6a, 0x2bb7c, 0x2bb83, 0x2bc1b, 0x2bc21, 0x2bc30, 0x2bca6, 0x2bd58, 0x2bd77, 0x2bd7c, 0x2bd87, 0x2bdf7, 0x2be29, 0x2bf1d, 0x2c081, 0x2c0a9, 0x2c0c0, 0x2c0ca, 0x2c1d5, 0x2c1d9, 0x2c1de, 0x2c1f9, 0x2c27c, 0x2c288, 0x2c2a4, 0x2c2b6, 0x2c317, 0x2c35b, 0x2c361, 0x2c364, 0x2c386, 0x2c457, 0x2c488, 0x2c494, 0x2c497, 0x2c542, 0x2c58b, 0x2c59e, 0x2c613, 0x2c618, 0x2c629, 0x2c62f, 0x2c635, 0x2c642, 0x2c72c, 0x2c72f, 0x2c79f, 0x2c7c1, 0x2c7fd, 0x2c816, 0x2c88a, 0x2c8c0, 0x2c8d9, 0x2c8de, 0x2c8e1, 0x2c8f3, 0x2c907, 0x2c90a, 0x2c91d, 0x2c9b0, 0x2c9c0, 0x2ca02, 0x2ca0e, 0x2ca7d, 0x2ca8d, 0x2caa9, 0x2cad2, 0x2cb29, 0x2cb2b, 0x2cb31, 0x2cb3f, 0x2cb41, 0x2cb4a, 0x2cb4e, 0x2cb69, 0x2cb6c, 0x2cb6f, 0x2cb73, 0x2cb76, 0x2cb78, 0x2cb7c, 0x2cba4, 0x2cbb1, 0x2cbb4, 0x2cbce, 0x2cc56, 0x2cc5f, 0x2ccb1, 0x2ccbd, 0x2ccc7, 0x2ccfd, 0x2ccff, 0x2cd0a, 0x2cd88, 0x2cd8b, 0x2cd8d, 0x2cda8, 0x2cdd5, 0x2ce05, 0x2ce18, 0x2ce1a, 0x2ce23, 0x2ce26, 0x2ce2a, 0x2ce7c, 0x2ce88, 0x2ce93, 0x2d25d, 0x2d382, 0x2d544, 0x2dc4a, 0x2dd0a, 0x2e014, 0x2e26f, 0x2e41a, 0x2e428, 0x2e502, 0x2e505, 0x2e50a, 0x2e5b1, 0x2e779, 0x2e932, 0x2e9f5, 0x2ea3b, 0x2eaa5, 0x2eb1d, 0x2eb21, 0x2eb66, 0x2eb68, 0x2ebd9, 0x2f884, 0x2f8b6, 0x300f7, 0x301db, 0x301e3, 0x302c0, 0x30300, 0x30302, 0x30787, 0x307d8, 0x30858, 0x308fb, 0x30915, 0x30abf, 0x30bfc, 0x30c72, 0x30d67, 0x30d74, 0x30d7c, 0x30d8a, 0x30de5, 0x30e6c, 0x30f57, 0x30f5a, 0x30f74, 0x30f7d, 0x30fa0, 0x30fab, 0x3106c, 0x31090, 0x310a9, 0x310b1, 0x310ea, 0x310f1, 0x310fa, 0x3114b, 0x3115b, 0x311e3, 0x311f1, 0x31254, 0x3132e, 0x313bc, 0x313ff, 0x3158e, 0x31592, 0x31b92, 0x31b9c, 0x31c7f, 0x31d1f, 0x31d31, 0x31e07, 0x31e4d, 0x32003, 0x3208e, 0x32217, 0x322e4, 0x3235b, 0x3236d, 0x3237f};

    static {
        Unifont u = new Unifont();

        // load all in the ranges
        for (int[] range : u.ranges) {
            int start = range[0];
            int end = range[1];

            //for all in between
            for (int cp = start; cp <= end; cp++) {
                //if allowed, add to alphabet
                if (isAllowed(cp)) ALPHABET.add(cp);
            }

        }

        // load all singles
        for (int cp : u.special) {
            //if allowed, add to alphabet
            if (isAllowed(cp)) ALPHABET.add(cp);
        }

        //also build reverse map
        for (int i = 0; i < ALPHABET.size(); i++) {
            REVERSE.put(ALPHABET.get(i), i);
        }

        BASE = BigInteger.valueOf(ALPHABET.size());
        System.out.println("Loaded " + BASE + " visible printable symbols for encoding.");
    }


    private static boolean isAllowed(int cp) {
        if(cp == 0x14) return true; // allow U+0020 (space:' ') explicitly

        // skip undefined, control, and whitespace characters
        if (!Character.isDefined(cp)) return false;
        if (Character.isISOControl(cp)) return false;
        if (Character.isWhitespace(cp)) return false;

        // skip zero-width / format characters
        int type = Character.getType(cp);
        if (type == Character.FORMAT || type == Character.SPACE_SEPARATOR) return false;

        // skip invisible marks and bidi controls (At least i think these are invisible and bidi)
        if (cp == 0x200B || cp == 0x200C || cp == 0x200D || cp == 0xFEFF) return false;
        return true;
    }

    public static String encode(BigInteger number) {
        if (number.signum() < 0) throw new IllegalArgumentException("Negative not supported");
        //I think this is only a very slight optimization (but this case is queried quite often, would have to test) Maybe directly returning "!" is better (meaning a final static String for that))
        if (number.equals(BigInteger.ZERO)) return new String(Character.toChars(ALPHABET.getFirst()));

        StringBuilder s = new StringBuilder();

        while (number.compareTo(BigInteger.ZERO) > 0) {
            BigInteger[] divMod = number.divideAndRemainder(BASE);
            int idx = divMod[1].intValue();
            s.appendCodePoint(ALPHABET.get(idx));
            number = divMod[0];
        }

        return s.reverse().toString();
    }

    public static BigInteger decode(String str) {

        BigInteger value = BigInteger.ZERO;
        for (int cp : str.codePoints().toArray()) {
            Integer idx = REVERSE.get(cp);
            if (idx == null) throw new IllegalArgumentException(String.format("Invalid character U+%04X", cp));
            value = value.multiply(BASE).add(BigInteger.valueOf(idx));
        }

        return value;
    }
}
